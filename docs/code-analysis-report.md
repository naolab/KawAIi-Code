# AI-Kawaii-Project コード調査レポート

## 1. 音声読み上げシステム

### 現状の実装
- **メインの音声処理**: `src/app.js` で管理
- **Hookシステム**: `scripts/voice-synthesis-hook.js` で Claude Code Hooks を利用
- **音声キュー管理**: `audioQueue` 配列で音声データを管理（最大50件）
- **ファイルベース通知**: tempディレクトリに通知JSONファイルを作成して音声再生を通知

### 重複や問題点
1. **音声再生処理の重複**
   - `playAudio()` と `playHookVoiceFile()` で似たような処理
   - Hook機能が常時有効なのに、従来の音声合成処理が残存
   
2. **音声ファイル管理の複雑性**
   - tempディレクトリのクリーンアップが複数箇所で実装
   - 起動時と実行時で異なるクリーンアップロジック

3. **設定読み込みの重複**
   - 統一設定システムとフォールバック処理が混在
   - voiceEnabled、selectedSpeakerの管理が複数箇所に分散

### パフォーマンスの懸念
- 音声ファイルの頻繁なファイルI/O操作
- 1秒間隔でのnotificationファイル監視（ポーリング）
- AudioContextの重複作成可能性

## 2. 表情管理システム

### 現状の実装
- **感情分析**: `src/emotionAnalyzer.js` でテキストから感情を分析
- **表情制御**: `ai-kawaii-nextjs/src/features/emoteController/` で VRM の表情を制御
- **IPC通信**: `src/modules/emotion-ipc-handler.js` で感情データを送信

### 重複や問題点
1. **感情データの送信経路が複雑**
   - WebSocket送信（現在は無効化）
   - IPC経由での送信
   - postMessageでの送信
   
2. **表情リセットタイミングの不統一**
   - 音声終了時の手動リセット
   - 自動リセットタイマー（現在は無効化）
   - 表情遷移のトランジション処理

3. **感情パターンの重複定義**
   - emotionAnalyzer.jsで定義
   - CLAUDE.mdでも同様の定義

### パフォーマンスの懸念
- 16ms間隔での表情アニメーション更新
- 複数の表情を同時に適用する際の計算負荷
- postMessageの頻繁な送信

## 3. フック設定とIPC通信

### 現状の実装
- **Hook音声**: voice-synthesis-hook.js で処理
- **ファイルベース通知**: notificationファイルで音声再生を通知
- **IPC通信**: 感情データの送信に使用

### 重複や問題点
1. **通信方式の混在**
   - WebSocket（無効化済み）
   - IPC（感情データ）
   - ファイルベース（音声通知）
   - postMessage（VRMビューワーへ）

2. **Hook処理の複雑性**
   - 標準入力からJSONを読み込み
   - transcriptファイルを解析
   - 複数の『』テキストを順次処理

### パフォーマンスの懸念
- ファイルベース通知の1秒ポーリング
- transcriptファイルの頻繁な読み込み
- 複数の通信チャンネルの管理オーバーヘッド

## 4. 設定管理

### 現状の実装
- **統一設定システム**: `src/modules/unified-config-manager.js`
- **階層的管理**: runtime > user > ui > default の優先順位
- **複数のアダプター**: Memory、LocalStorage、ElectronStore

### 重複や問題点
1. **設定の分散**
   - app.js内のローカル変数
   - 統一設定システム
   - ConfigManagerクラス
   
2. **移行処理の複雑性**
   - LocalStorageからの自動マイグレーション
   - JSON解析エラーのハンドリング

### パフォーマンスの懸念
- 設定読み込み時の非同期処理
- 複数のストレージアダプターへのアクセス

## 5. パフォーマンスボトルネック

### 特定された問題
1. **ファイルI/O**
   - 音声ファイルの頻繁な読み書き
   - notificationファイルのポーリング（1秒間隔）
   - 設定ファイルの読み込み

2. **タイマー処理**
   - MessageAccumulatorの完了タイマー
   - 表情アニメーションの16ms更新
   - Hook監視の1秒ポーリング

3. **メモリ使用**
   - audioQueue最大50件の保持
   - chatMessages最大50件の保持
   - 複数のVRM表情トランジション

## 改善提案

### 1. 音声システムの統一
- Hook機能を完全に統合し、従来の音声処理を削除
- 音声ファイルのインメモリキャッシュ導入
- ファイルベース通知からイベントベースへの移行

### 2. 表情管理の簡素化
- 感情データ送信を単一チャンネル（IPC）に統一
- 表情リセットロジックの一元化
- 感情パターン定義の統合

### 3. 通信アーキテクチャの整理
- WebSocket関連コードの完全削除
- IPC通信の拡張（音声通知も含む）
- postMessageの最適化

### 4. 設定管理の最適化
- 設定のキャッシュ強化
- 非同期初期化の改善
- 不要な移行処理の削除

### 5. パフォーマンス最適化
- ポーリングからイベント駆動への移行
- ファイルI/Oの削減
- タイマー処理の統合と最適化
- メモリ使用量の削減（キューサイズの調整）

## まとめ
現在のシステムは機能的には動作していますが、複数の実装方式が混在しており、パフォーマンスと保守性の観点から改善の余地があります。特に、Hook機能への完全移行、通信チャンネルの統一、ポーリングの削減が重要な改善点となります。