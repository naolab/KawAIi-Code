# 🛠️ KawAIi Code 配布改善実装計画

## 📅 実装スケジュール概要

本計画は、KawAIi Codeを他のユーザー環境で確実に動作させるための改善実装計画です。
優先度に応じて3つのフェーズに分けて実装を進めます。

### フェーズ1: 緊急対応（1-2日）
- 配布を阻害する致命的な問題の修正
- 最小限の動作保証

### フェーズ2: 基本改善（3-5日）
- ユーザビリティの向上
- 環境依存の削減

### フェーズ3: 最適化（1週間）
- クロスプラットフォーム対応
- 自動化とCI/CD構築

---

## 🚨 フェーズ1: 緊急対応項目

### 1.1 node-ptyリビルド処理の実装

**問題**: ネイティブモジュールが配布先で動作しない

**実装内容**:

#### package.jsonの修正
```json
{
  "scripts": {
    "postinstall": "electron-rebuild -f -w node-pty",
    "rebuild": "electron-rebuild -f -w node-pty",
    "build": "npm run rebuild && node build.js build",
    "clean-build": "npm run clean && npm install && npm run build"
  }
}
```

#### build.jsの改善
```javascript
// Step 2.5: ネイティブモジュールのリビルド
console.log('\n2.5️⃣ ネイティブモジュールをリビルド中...');
try {
  // electron-rebuildの存在確認
  const hasElectronRebuild = fs.existsSync(
    path.join(__dirname, 'node_modules', '.bin', 'electron-rebuild')
  );
  
  if (hasElectronRebuild) {
    execSync('npm run rebuild', { stdio: 'inherit' });
    console.log('✅ ネイティブモジュールリビルド完了');
  } else {
    console.warn('⚠️  electron-rebuildが見つかりません。手動でのリビルドが必要です。');
  }
} catch (error) {
  console.error('⚠️  ネイティブモジュールのリビルドに失敗:', error.message);
  console.error('配布版が正常に動作しない可能性があります。');
  // ビルドは続行（エラーで止めない）
}
```

### 1.2 署名設定の環境変数化

**問題**: 個人の署名情報がハードコードされている

**実装内容**:

#### package.jsonの修正
```json
{
  "build": {
    "mac": {
      "identity": null,  // 環境変数から取得
      "notarize": false  // デフォルトでは無効
    }
  }
}
```

#### build.jsでの環境変数処理
```javascript
// 署名設定の動的読み込み
if (process.env.APPLE_IDENTITY) {
  console.log('📝 Apple署名を使用します');
  execSync(`npx electron-builder ${buildArgs} --mac.identity="${process.env.APPLE_IDENTITY}"`, { 
    stdio: 'inherit' 
  });
} else {
  console.log('📝 署名なしでビルドします');
  execSync(`npx electron-builder ${buildArgs}`, { stdio: 'inherit' });
}
```

### 1.3 インストール説明書の更新

**実装内容**:

`docs/インストール説明書.md`に以下を追加:

```markdown
## ⚠️ 動作要件と制限事項

### 必須要件
- **Claude Code**: 事前にインストールが必要です
- **macOS 10.15以降**: Apple Silicon推奨

### オプション機能
- **音声合成**: AivisSpeech（ポート10101）が必要
- **フック機能**: Node.js 14以降が必要

### 既知の制限
- 初回起動時にセキュリティ警告が表示されます
- ポート8080, 3002が使用されている場合は動作しません
```

---

## 🔧 フェーズ2: 基本改善項目

### 2.1 Claude Codeパス自動検出の改善

**実装内容**:

#### ai-config-service.jsの改善
```javascript
const { execSync } = require('child_process');

class AIConfigService {
  async findClaudePath() {
    // 1. 環境変数を最優先
    if (process.env.CLAUDE_PATH) {
      return process.env.CLAUDE_PATH;
    }
    
    // 2. whichコマンドで検索
    try {
      const path = execSync('which claude', { encoding: 'utf8' }).trim();
      if (path) return path;
    } catch (e) {
      // whichが失敗した場合は続行
    }
    
    // 3. 既知のパスを順番に確認
    const knownPaths = [
      '/opt/homebrew/bin/claude',
      '/usr/local/bin/claude',
      '/usr/bin/claude',
      process.platform === 'win32' ? 'C:\\Program Files\\Claude\\claude.exe' : null
    ].filter(Boolean);
    
    for (const path of knownPaths) {
      if (fs.existsSync(path)) {
        return path;
      }
    }
    
    // 4. PATHに頼る
    return 'claude';
  }
}
```

### 2.2 ポート設定の外部化

**実装内容**:

#### config構造の拡張
```javascript
// appConfig.jsに追加
const defaultConfig = {
  ports: {
    websocket: process.env.WEBSOCKET_PORT || 8080,
    nextjs: process.env.NEXTJS_PORT || 3002,
    aivisSpeech: process.env.AIVISSPEECH_PORT || 10101
  }
};
```

#### 起動時のポート確認
```javascript
// main.jsに追加
async function checkPortAvailability(port) {
  const net = require('net');
  return new Promise((resolve) => {
    const server = net.createServer();
    server.once('error', () => resolve(false));
    server.once('listening', () => {
      server.close();
      resolve(true);
    });
    server.listen(port);
  });
}

// 起動前にポートチェック
const wsPort = appConfig.get('ports.websocket', 8080);
if (!await checkPortAvailability(wsPort)) {
  console.error(`ポート${wsPort}が使用中です。設定を変更してください。`);
  // 代替ポートを提案
}
```

### 2.3 依存関係の整理

**実装内容**:

#### package.jsonのクリーンアップ
```json
{
  "devDependencies": {
    "electron": "^27.0.0",
    "electron-builder": "^24.6.4",
    "electron-rebuild": "^3.2.9"  // 統一
  }
}
```

### 2.4 エラーハンドリングの改善

**実装内容**:

#### 起動時の診断機能
```javascript
// main.jsに診断機能を追加
async function runStartupDiagnostics() {
  const diagnostics = {
    claudeCode: false,
    nodePty: false,
    ports: {
      websocket: false,
      nextjs: false
    },
    permissions: true
  };
  
  // Claude Codeの確認
  try {
    execSync('claude --version');
    diagnostics.claudeCode = true;
  } catch (e) {
    console.error('Claude Codeが見つかりません');
  }
  
  // node-ptyの確認
  try {
    require('node-pty');
    diagnostics.nodePty = true;
  } catch (e) {
    console.error('node-ptyの読み込みに失敗');
  }
  
  return diagnostics;
}
```

---

## 🚀 フェーズ3: 最適化項目

### 3.1 GitHub Actions CI/CD構築

**実装内容**:

`.github/workflows/build.yml`:
```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          - os: macos-latest
            arch: [x64, arm64]
          - os: windows-latest
            arch: [x64]
          - os: ubuntu-latest
            arch: [x64]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm ci
        cd ai-kawaii-nextjs && npm ci
    
    - name: Rebuild native modules
      run: npm run rebuild
    
    - name: Build
      run: npm run build
      env:
        APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.os }}-${{ matrix.arch }}
        path: dist/
```

### 3.2 自動テストスイート

**実装内容**:

`test/distribution.test.js`:
```javascript
const { describe, it, expect } = require('@jest/globals');
const fs = require('fs');
const path = require('path');

describe('配布版ビルドテスト', () => {
  it('node-ptyが正しくリビルドされている', () => {
    const nodePtyPath = path.join(__dirname, '../node_modules/node-pty/build/Release/pty.node');
    expect(fs.existsSync(nodePtyPath)).toBe(true);
  });
  
  it('Next.jsがビルドされている', () => {
    const outDir = path.join(__dirname, '../ai-kawaii-nextjs/out');
    expect(fs.existsSync(outDir)).toBe(true);
  });
  
  it('必要な設定ファイルが存在する', () => {
    // 設定ファイルの確認
  });
});
```

### 3.3 配布用スクリプト

**実装内容**:

`scripts/prepare-distribution.js`:
```javascript
#!/usr/bin/env node

const fs = require('fs-extra');
const path = require('path');

async function prepareDistribution() {
  console.log('🚀 配布準備を開始します...');
  
  // 1. 不要なファイルを削除
  const filesToRemove = [
    'node_modules',
    '.git',
    'test',
    'docs',
    '*.log'
  ];
  
  // 2. 配布用READMEを生成
  await generateDistributionReadme();
  
  // 3. 環境チェックスクリプトを追加
  await createEnvironmentChecker();
  
  console.log('✅ 配布準備完了');
}

async function createEnvironmentChecker() {
  const checkerScript = `
#!/usr/bin/env node
console.log('KawAIi Code 環境チェック');
// 環境チェックロジック
  `;
  
  await fs.writeFile('check-environment.js', checkerScript);
}
```

---

## 📊 実装優先度マトリックス

| 項目 | 緊急度 | 影響度 | 実装工数 | 優先順位 |
|------|--------|--------|----------|----------|
| node-ptyリビルド | 高 | 高 | 小 | 1 |
| 署名設定の柔軟化 | 高 | 中 | 小 | 2 |
| ドキュメント更新 | 高 | 中 | 小 | 3 |
| Claude Codeパス検出 | 中 | 高 | 中 | 4 |
| ポート設定外部化 | 中 | 中 | 中 | 5 |
| CI/CD構築 | 低 | 高 | 大 | 6 |

---

## ✅ 実装完了チェックリスト

### フェーズ1完了条件
- [ ] node-ptyリビルド処理が実装されている
- [ ] 署名なしでビルドできる
- [ ] インストール説明書に制限事項が明記されている

### フェーズ2完了条件
- [ ] Claude Codeが自動検出される
- [ ] ポート競合時にエラーメッセージが表示される
- [ ] 起動時診断が実装されている

### フェーズ3完了条件
- [ ] 3つのOS向けの自動ビルドが設定されている
- [ ] 配布版の自動テストが実装されている
- [ ] 環境チェックツールが同梱されている

---

## 📝 実装時の注意事項

1. **後方互換性**: 既存ユーザーの設定を壊さない
2. **段階的リリース**: 各フェーズ完了後にテストリリース
3. **ドキュメント同期**: コード変更と同時にドキュメント更新
4. **エラーメッセージ**: ユーザーフレンドリーな日本語メッセージ
5. **フォールバック**: 各機能に適切なフォールバック処理

---

この実装計画に従って段階的に改善を進めることで、KawAIi Codeをより多くのユーザーが簡単に使えるようになります。