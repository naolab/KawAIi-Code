# 二通りの音声読み上げシステム実装計画

## 概要
Claude Code Hooks使用設定により、2つの音声読み上げモードを切り替える機能を実装する。

## 現在の状況分析

### 既存システム
- Claude Code Hooksがグローバルに有効（`~/.claude/settings.json`）
- アプリ設定に`use-hooks-toggle`は存在するが完全連動していない
- Hookスクリプトで`useHooks`設定チェック機能は実装済み
- 統一設定システム（`unified-config-manager.js`）で設定管理

### 問題点
- 複数ターミナルで同時に音声読み上げが発生
- 特定ターミナルのみの読み上げ制御が困難
- Hook設定変更にはグローバル設定の変更が必要

## 実装プラン

### 1. Hook音声モード (useHooks = ON)
**現在の仕組みを維持・強化**

#### 動作概要
- Claude Code Hooksがターミナル出力を監視
- `⏺`記号付きテキストを抽出して音声合成
- ファイルベース通知またはIPC通信でアプリに送信

#### 技術的詳細
- `scripts/voice-synthesis-hook.js`の既存機能を活用
- `src/app.js`の`startHookFileWatcher()`でファイル監視
- `setupHookIPCListeners()`でIPC通信処理
- 感情分析機能（`EmotionAnalyzer`）による表情連動

#### 利点
- 複数プロジェクトで動作
- Claude Code本体の出力を直接解析
- 高度な感情分析機能

### 2. アプリ内監視モード (useHooks = OFF)
**新機能として実装**

#### 動作概要
- アプリ内の親タブターミナルのみを監視
- xtermからの出力データをリアルタイム解析
- `『』`で囲まれたテキストを抽出して即座に音声合成
- Hook機能に依存せず、完全にアプリ内で処理

#### 実装箇所と詳細

##### 2.1 ターミナル監視システム
**ファイル:** `src/app.js`
- `setupTerminalMonitoring()`メソッド追加
- 親タブのxtermインスタンスからリアルタイム出力取得
- 既存の`MessageAccumulator`クラスを拡張活用

##### 2.2 テキスト抽出・解析
**ファイル:** `src/voiceService.js`
- `parseTerminalOutputForApp()`メソッド追加
- `『』`で囲まれたテキストの抽出ロジック
- 感情分析機能の統合

##### 2.3 UI設定連動
**ファイル:** `src/modules/ui-event-manager.js`
- `use-hooks-toggle`の変更検知
- 設定変更時のモード切り替え処理
- リアルタイム設定反映

##### 2.4 統一設定システム
**ファイル:** `src/modules/unified-config-manager.js`
- `useHooks`設定の管理強化
- Hook/アプリ内モード切り替え処理

#### 利点
- 特定ターミナルのみの音声読み上げが可能
- Hook設定を変更せずにアプリ単体で制御
- より細かい制御とカスタマイズが可能
- 他のプロジェクトに影響しない

## 実装手順

### Phase 1: 設定連動システムの強化
1. `unified-config-manager.js`での`useHooks`設定管理の強化
2. `ui-event-manager.js`での設定切り替え処理実装
3. Hook/アプリ内モード切り替えロジック実装

### Phase 2: アプリ内監視システムの実装
1. `src/app.js`にターミナル監視システム追加
2. `src/voiceService.js`にアプリ内用テキスト解析機能追加
3. xterm出力からのリアルタイムテキスト抽出実装

### Phase 3: 統合とテスト
1. 両モードの動作確認
2. 設定切り替え時の動作テスト
3. 感情分析機能の統合テスト

## 技術的考慮事項

### パフォーマンス
- アプリ内監視モードでのCPU使用量の最適化
- リアルタイム処理での適切なデバウンス処理
- メモリリークの防止

### 互換性
- 既存Hook機能との完全互換性維持
- 設定変更時の適切なフォールバック処理
- 既存の感情分析・表情連動機能の継承

### エラーハンドリング
- モード切り替え時のエラー処理
- ターミナル監視エラーの適切な処理
- 音声合成エラー時のフォールバック

## 期待される効果

1. **柔軟性の向上**
   - 用途に応じた音声読み上げモード選択
   - 他のプロジェクトへの影響を排除

2. **ユーザビリティの向上**
   - 特定ターミナルのみの読み上げ制御
   - 設定変更の簡素化

3. **システムの安定性**
   - Hook依存の削減オプション
   - アプリ内完結による安定性向上

## 実装後の運用

### 推奨設定
- **開発作業時**: アプリ内監視モード（useHooks = OFF）
- **複数プロジェクト管理時**: Hook音声モード（useHooks = ON）

### 設定切り替え方法
1. アプリ設定画面の「Claude Code Hooks使用」トグル
2. 即座にモード切り替え（再起動不要）
3. 設定は統一設定システムで永続化

この実装により、ユーザーは状況に応じて最適な音声読み上げ体験を選択できるようになる。