<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' file: data:; script-src 'self' https://unpkg.com https://cdn.skypack.dev https://cdn.jsdelivr.net https://threejs.org; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src-elem 'self' 'unsafe-inline' https://cdn.jsdelivr.net; frame-src 'self'; child-src 'self'; connect-src 'self' http://localhost:10101 ws://localhost:8080 https://api.aivis-project.com; media-src 'self' blob: data:;">
    <title>KawAIi Code</title>
    <link rel="stylesheet" href="./styles/main.css">
    <link rel="icon" href="./assets/icons/favicon.ico" type="image/x-icon">
    <!-- xterm.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
    <!-- Loading Screen -->
    <script src="./components/LoadingScreen.js"></script>
</head>
<body>
    <!-- AI選択モーダル -->
    <div id="ai-select-modal" class="settings-modal" style="display: none;">
        <div class="settings-content">
            <div class="settings-header">
                <h3>AIアシスタントを選択</h3>
                <button id="close-ai-select" class="close-btn">×</button>
            </div>
            <div class="settings-body" style="text-align: center; padding: 30px;">
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button id="start-claude" class="simple-btn" style="width: 140px; background-color: #ff6b35;">Claude Code</button>
                    <button id="start-claude-dangerous" class="simple-btn" style="width: 170px; background-color: #ff3535;">Claude Code (Dangerous)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <div class="header-left">
                <button id="settings-btn" class="settings-btn" aria-label="設定を開く">
                    <span class="gear-horizontal"></span>
                    <span class="gear-diagonal"></span>
                    <span class="gear-diagonal"></span>
                    <span class="gear-diagonal"></span>
                    <span class="gear-diagonal"></span>
                </button>
                <button id="debug-stats-btn" class="settings-btn history-btn" aria-label="会話ログを表示" title="会話ログ">
                    <span class="clock-hand-short"></span>
                    <span class="clock-hand-long"></span>
                </button>
                <button id="help-btn" class="settings-btn help-btn" aria-label="使い方を見る">
                </button>
            </div>
            <div class="controls">
                <button id="terminal-toggle" class="simple-btn terminal-toggle-btn" aria-label="ターミナル表示切り替え">
                    <span class="pupil"></span>
                </button>
                <button id="start-ai-selection" class="simple-btn start-btn" aria-label="AIアシスタントを開始"></button>
                <button id="stop-terminal" class="simple-btn stop-btn" aria-label="AIアシスタントを停止"></button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="terminal-section">
                <!-- タブバー -->
                <div id="tab-bar" class="tab-bar">
                    <!-- タブは動的に追加される -->
                    <button id="new-tab-button" class="new-tab-button" title="新しいタブを作成">+</button>
                </div>
                
                <!-- ターミナルコンテナ -->
                <div id="terminal-container" class="terminal-container">
                    <div id="terminal" class="terminal-wrapper active"></div>
                </div>
            </div>
            
            <div class="character-section">
                <div class="character-main">
                    <iframe id="vrm-iframe" 
                            src="../ai-kawaii-nextjs/out/index.html" 
                            style="width: 100%; height: calc(100% + 70px); border: none; background: transparent; border-radius: 20px; margin-top: -70px;"
                            allow="accelerometer; gyroscope">
                    </iframe>
                </div>
            </div>
        </div>
        
        
        
        <!-- 設定画面 -->
        <div id="settings-modal" class="settings-modal" style="display: none;">
            <div class="settings-content">
                <div class="settings-header">
                    <h3>設定</h3>
                    <button id="close-settings" class="close-btn">×</button>
                </div>
                <div class="settings-body">
                    <div class="setting-group">
                        <label for="voice-toggle-modal">音声読み上げ</label>
                        <input type="checkbox" id="voice-toggle-modal">
                    </div>
                    
                    <div class="setting-group">
                        <label for="use-hooks-toggle">Claude Code Hooksで読み上げ</label>
                        <div class="setting-switch">
                            <input type="checkbox" id="use-hooks-toggle">
                            <label for="use-hooks-toggle" class="switch-label"></label>
                        </div>
                        <div style="margin-top: 5px; margin-bottom: 8px;">
                            <span style="color: #ff6b35; font-size: 12px; font-weight: 500;">⚠️ この機能は現在開発中のため使用できません</span>
                        </div>
                        <div style="margin-top: 5px;">
                            <button id="hooks-info-btn" class="simple-btn" style="width: auto; min-width: 120px; opacity: 0.5; cursor: not-allowed;" disabled>この機能について</button>
                        </div>
                    </div>
                    
                    <!-- Aivis Cloud API設定セクション -->
                    <div class="setting-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin: 15px 0; background-color: #f9f9f9;">
                        <h4 style="margin: 0 0 12px 0; color: #333; font-size: 14px;">Aivis Cloud API設定（ベータ）</h4>
                        
                        <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <label for="use-cloud-api-toggle">クラウドAPIを使用</label>
                            <div class="setting-switch">
                                <input type="checkbox" id="use-cloud-api-toggle">
                                <label for="use-cloud-api-toggle" class="switch-label"></label>
                            </div>
                        </div>
                        
                        <div id="cloud-api-settings" style="display: none;">
                            <div class="setting-item" style="margin-bottom: 12px;">
                                <label for="cloud-api-key-input" style="display: block; margin-bottom: 5px; font-size: 13px;">APIキー</label>
                                <input type="password" id="cloud-api-key-input" placeholder="APIキーを入力" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button id="test-cloud-api-btn" class="simple-btn" style="flex: 1;">接続テスト</button>
                                <button id="save-cloud-api-btn" class="simple-btn" style="flex: 1;">保存</button>
                            </div>
                            
                            <div id="cloud-api-status" style="margin-top: 10px; font-size: 12px; padding: 8px; border-radius: 4px; display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="speaker-select-modal">話者選択</label>
                        <select id="speaker-select-modal" class="speaker-select">
                            <option value="0">話者を選択...</option>
                        </select>
                    </div>
                    
                    <div class="setting-group connection-status-group">
                        <span>音声エンジン接続状況</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="connection-status-modal">接続確認中...</span>
                            <button id="refresh-connection-modal" class="simple-btn">再接続</button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="voice-interval-slider">読み上げ間隔</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #666;">短い</span>
                            <input type="range" id="voice-interval-slider" min="0" max="6" step="0.5" value="0.5" style="flex: 1;">
                            <span style="font-size: 12px; color: #666;">長い</span>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="voice-volume-slider">音量調整</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #666;">小</span>
                            <input type="range" id="voice-volume-slider" min="0" max="100" step="5" value="50" style="flex: 1;">
                            <span style="font-size: 12px; color: #666;">大</span>
                        </div>
                    </div>
                    
                    <!-- CLAUDE.md設定セクション -->
                    <div class="setting-group">
                        <label>CLAUDE.md設定</label>
                        
                        <!-- 生成先表示 -->
                        <div class="setting-item" style="margin-top: 8px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">生成先</label>
                            <div style="padding: 8px 12px; background: #f0f0f0; border-radius: 4px; font-size: 13px; color: #666; word-break: break-all;">
                                <span id="workspace-path-display">読み込み中...</span>
                            </div>
                        </div>
                        
                        <!-- 操作ボタン群 -->
                        <div class="claude-md-action-buttons" style="display: flex; gap: 6px; margin-top: 10px;">
                            <button id="claude-md-generate-btn" class="simple-btn" style="flex: 1; min-width: 100px;">生成</button>
                            <button id="claude-md-info-btn" class="simple-btn" style="flex: 1; min-width: 120px;">この機能について</button>
                        </div>
                        
                        <!-- 内容編集エリア -->
                        <div class="setting-item" style="margin-top: 10px;">
                            <label for="claude-md-content-editor" style="display: block; margin-bottom: 5px; font-size: 13px;">CLAUDE.md内容</label>
                            <textarea id="claude-md-content-editor" 
                                      style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"
                                      placeholder="CLAUDE.mdの内容を編集してください..."></textarea>
                        </div>
                        
                        <!-- 読み込みボタン群 -->
                        <div class="claude-md-load-buttons" style="display: flex; gap: 6px; margin-top: 10px;">
                            <button id="claude-md-load-btn" class="simple-btn" style="flex: 1; min-width: 140px;">現在の内容を読み込み</button>
                            <button id="claude-md-default-btn" class="simple-btn" style="flex: 1; min-width: 140px;">デフォルト内容を読み込み</button>
                        </div>
                    </div>
                    
                    <!-- 壁紙設定セクション -->
                    <div class="setting-group">
                        <label>壁紙設定</label>
                        <div class="wallpaper-controls" style="display: flex; flex-direction: column; gap: 10px;">
                            <label class="radio-label">
                                <input type="radio" name="wallpaper-option" id="wallpaper-default-radio" value="default">
                                <span>デフォルト壁紙を使用する</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="wallpaper-option" id="wallpaper-uploaded-radio" value="uploaded">
                                <span>アップロードした壁紙を使用する</span>
                            </label>
                            <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
                            <button id="upload-wallpaper-btn" class="simple-btn" style="width: auto;">壁紙をアップロード</button>
                            <!-- アップロードした壁紙の名前を表示する要素を追加 -->
                            <span id="uploaded-wallpaper-name" style="font-size: 13px; color: #555; word-break: break-all; min-height: 20px;"></span>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="wallpaper-animation-toggle">デフォルト壁紙のアニメーション</label>
                        <div class="setting-switch">
                            <input type="checkbox" id="wallpaper-animation-toggle">
                            <label for="wallpaper-animation-toggle" class="switch-label"></label>
                        </div>
                    </div>
                    
                    
                    <!-- Claude Code 作業ディレクトリ設定セクション -->
                    <div class="setting-group">
                        <label>作業ディレクトリ設定</label>
                        <div class="claude-cwd-controls" style="display: flex; flex-direction: column; gap: 8px;">
                            <span id="claude-cwd-display" style="font-size: 13px; color: #555; word-break: break-all; min-height: 20px;">読み込み中...</span>
                            <button id="select-claude-cwd-btn" class="simple-btn">作業ディレクトリを選択</button>
                            <div id="claude-cwd-message" style="font-size: 12px; margin-top: 5px; min-height: 15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ヘルプ・使い方ガイド -->
        <div id="help-modal" class="help-modal" style="display: none;">
            <div class="help-content">
                <div class="help-header">
                    <h3>使い方ガイド</h3>
                    <button id="close-help" class="close-btn">×</button>
                </div>
                <div class="help-body">
                    <div class="help-section">
                        <h4>基本操作</h4>
                        <div class="help-item">
                            <strong>開始ボタン:</strong> AI選択してチャットを開始します
                        </div>
                        <div class="help-item">
                            <strong>停止ボタン:</strong> AIアシスタントを停止します
                        </div>
                        <div class="help-item">
                            <strong>表示切り替え:</strong> ターミナル表示を切り替えます
                        </div>
                        <div class="help-item">
                            <strong>設定ボタン:</strong> 音声・壁紙・ディレクトリを設定します
                        </div>
                        <div class="help-item">
                            <strong>ヘルプボタン:</strong> 使い方ガイドを表示します
                        </div>
                        <div class="help-item">
                            <strong>会話ログボタン:</strong> 過去の会話履歴を確認できます
                        </div>
                    </div>
                    
                    
                    <div class="help-section">
                        <h4>キャラクター機能</h4>
                        <div class="help-item">
                            <strong>音声合成:</strong> AivisSpeech連携により、AIの応答が音声で読み上げられます。
                        </div>
                        <div class="help-item">
                            <strong>ファイルボタン:</strong> 表示するキャラクターを変更できます
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4>カスタマイズ</h4>
                        <div class="help-item">
                            <strong>作業ディレクトリ:</strong> AIアシスタントが動作するフォルダを設定できます。
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4>ヒント</h4>
                        <div class="help-item">
                            <strong>初回起動:</strong> 初めて使用する場合は、まず開始ボタンを押してAIアシスタントを起動してください。
                        </div>
                        <div class="help-item">
                            <strong>音声エンジン接続:</strong> 音声エンジンに接続できない場合は、設定の『再接続』ボタンをお試しください。
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Claude Code Hooksモードガイド -->
        <div id="hooks-guide-modal" class="help-modal" style="display: none;">
            <div class="help-content">
                <div class="help-header">
                    <h3>Claude Code Hooksモードについて</h3>
                    <button id="close-hooks-guide" class="close-btn">×</button>
                </div>
                <div class="help-body">
                    <div class="help-section">
                        <h4>🔧 Claude Code Hooksモードとは</h4>
                        <div class="help-item">
                            <span class="help-icon">📡</span>
                            <strong>グローバル監視機能:</strong> このアプリ以外のターミナルやエディターでClaude Codeを使用した際も、音声読み上げとVRM表情連動が働きます。
                        </div>
                        <div class="help-item">
                            <span class="help-icon">🎭</span>
                            <strong>高度な感情分析:</strong> より詳細な感情分析により、キャラクターの表情がより自然で豊かに変化します。
                        </div>
                        <div class="help-item">
                            <span class="help-icon">🌐</span>
                            <strong>システム全体対応:</strong> どこでClaude Codeを起動しても、このアプリが連動して動作します。
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4>📱 アプリ内のみモード vs 🔧 Hooksモード</h4>
                        <div class="help-item">
                            <span class="help-icon">📱</span>
                            <strong>アプリ内のみ（OFF）:</strong>
                            <ul>
                                <li>このアプリのターミナルでのみ動作</li>
                                <li>他のターミナルには影響しない</li>
                                <li>より安定した動作</li>
                                <li>リソース使用量が少ない</li>
                            </ul>
                        </div>
                        <div class="help-item">
                            <span class="help-icon">🔧</span>
                            <strong>Hooksモード（ON）:</strong>
                            <ul>
                                <li>システム全体のClaude Code活動を監視</li>
                                <li>外部ターミナルでも音声・表情連動</li>
                                <li>より豊かな感情表現</li>
                                <li>複数ターミナルで同時音声の可能性</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4>💡 使い分けの目安</h4>
                        <div class="help-item">
                            <span class="help-icon">🎯</span>
                            <strong>アプリ内のみがおすすめ:</strong>
                            <ul>
                                <li>このアプリだけでClaude Codeを使用</li>
                                <li>安定した動作を重視</li>
                                <li>他のアプリケーションに影響を与えたくない</li>
                            </ul>
                        </div>
                        <div class="help-item">
                            <span class="help-icon">⚡</span>
                            <strong>Hooksモードがおすすめ:</strong>
                            <ul>
                                <li>VSCode、Vim、別ターミナルでもClaude Codeを使用</li>
                                <li>どこでも音声・表情連動が欲しい</li>
                                <li>より豊かなキャラクター表現を楽しみたい</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4>⚠️ 注意事項</h4>
                        <div class="help-item">
                            <span class="help-icon">🔄</span>
                            <strong>同時実行:</strong> 複数のターミナルで同時にClaude Codeを使用すると、音声が重複する場合があります。
                        </div>
                        <div class="help-item">
                            <span class="help-icon">💻</span>
                            <strong>リソース:</strong> Hooksモードは常時監視のため、わずかにCPU使用量が増加します。
                        </div>
                        <div class="help-item">
                            <span class="help-icon">🔧</span>
                            <strong>設定切り替え:</strong> モード切り替えは設定画面からいつでも変更可能です。
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 会話ログ表示モーダル -->
        <div id="stats-log-modal" class="help-modal" style="display: none;">
            <div class="help-content">
                <div class="help-header">
                    <h3>会話ログ</h3>
                    <button id="close-stats-log" class="close-btn">×</button>
                </div>
                <div class="help-body">
                    <div class="help-section">
                        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <select id="log-count-select" class="speaker-select">
                                <option value="10">最新10件</option>
                                <option value="20" selected>最新20件</option>
                                <option value="50">最新50件</option>
                                <option value="100">最新100件</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 10px; padding: 8px 12px; background: #fff8dc; border: 1px solid #e0d090; border-radius: 6px; font-size: 12px; color: #666;">
                            <span style="font-weight: bold;">※</span> 読み上げた内容のみ記録されます
                        </div>
                        <div id="log-content" style="background: #f8f8f8; padding: 20px; border-radius: 8px; max-height: 500px; overflow-y: auto; font-size: 14px; line-height: 1.6; border: 1px solid #e0e0e0;">
                            <div style="text-align: center; color: #666;">ログを読み込み中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CLAUDE.md設定ガイド -->
        <div id="claude-md-guide-modal" class="help-modal" style="display: none;">
            <div class="help-content">
                <div class="help-header">
                    <h3>CLAUDE.md設定について</h3>
                    <button id="close-claude-md-guide" class="close-btn">×</button>
                </div>
                <div class="help-body">
                    <div class="help-section">
                        <h4>機能概要</h4>
                        <p>AIの性格・話し方をカスタマイズして、作業ディレクトリに保存する機能です。</p>
                    </div>
                    
                    <div class="help-section">
                        <h4>使い方</h4>
                        <div class="help-item">
                            <span class="help-icon">1️⃣</span>
                            <strong>読み込み</strong> → 既存ファイルまたはテンプレートを取得
                        </div>
                        <div class="help-item">
                            <span class="help-icon">2️⃣</span>
                            <strong>編集</strong> → テキストエリアでカスタマイズ
                        </div>
                        <div class="help-item">
                            <span class="help-icon">3️⃣</span>
                            <strong>生成</strong> → 設定を保存
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4>⚠️ 重要</h4>
                        <div class="help-item">
                            <span class="help-icon">🚫</span>
                            <strong>音声ルール部分は変更禁止</strong>
                        </div>
                        <div class="help-item">
                            <span class="help-icon">✅</span>
                            <strong>キャラクター設定部分は編集OK</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- xterm.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.js"></script>
    
    <!-- Logger（最初に読み込み） -->
    <script src="utils/logger.js"></script>
    
    <!-- 定数管理（最初に読み込み） -->
    <script src="constants/app-constants.js"></script>
    
    <!-- ターミナルファクトリー -->
    <script src="utils/terminal-factory.js"></script>
    
    <!-- SimpleDuplicateCheckerクラス -->
    <script src="classes/SimpleDuplicateChecker.js"></script>
    <!-- MessageAccumulatorクラス -->
    <script src="classes/MessageAccumulator.js"></script>
    
    <!-- VoiceQueueクラス -->
    <script src="classes/VoiceQueue.js"></script>
    
    <!-- AudioServiceクラス -->
    <script src="services/AudioService.js"></script>
    
    <!-- HookServiceクラス -->
    <script src="services/HookService.js"></script>
    
    <!-- VRMIntegrationServiceクラス -->
    <script src="services/VRMIntegrationService.js"></script>
    
    <!-- TerminalServiceクラス -->
    <script src="services/TerminalService.js"></script>
    
    <!-- TabManagerDependenciesクラス -->
    <script src="classes/TabManagerDependencies.js"></script>
    
    <!-- TabManagerクラス -->
    <script src="classes/TabManager.js"></script>
    
    <!-- リソース管理 -->
    <script src="utils/resource-manager.js"></script>
    
    <!-- 処理最適化 -->
    <script src="utils/processing-cache.js"></script>
    
    <!-- エラーハンドラー -->
    <script src="utils/error-handler.js"></script>
    
    <!-- 統一設定管理システム（最初に読み込み） -->
    <script src="modules/unified-config-manager.js"></script>
    
    <!-- モジュール -->
    <script src="modules/wallpaper-system.js"></script>
    <script src="modules/config-manager.js"></script>
    <script src="modules/speech-history-manager.js"></script>
    <script src="modules/ui-event-manager.js"></script>
    
    <!-- TerminalAppManager -->
    <script src="managers/TerminalAppManager.js"></script>
    
    <!-- App.js -->
    <script src="app.js"></script>
    
</body>
</html>
