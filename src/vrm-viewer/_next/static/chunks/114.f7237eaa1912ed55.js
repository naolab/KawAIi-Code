"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[114],{1114:(e,t,n)=>{n.r(t),n.d(t,{default:()=>_});var r=n(5155),i=n(2115),o=n(3264),a=n(7431),l=n(8635),s=n(9311),u=n(5416);class c{constructor(e,t){this._lookAtTarget=new o.B69,t.add(this._lookAtTarget),e.lookAt&&(e.lookAt.target=this._lookAtTarget)}}class d{setEnable(e){return(this._isAutoBlink=e,this._isOpen)?0:this._remainingTime}update(e){if(this._remainingTime>0){this._remainingTime-=e;return}if(this._isOpen&&this._isAutoBlink)return void this.close();this.open()}close(){this._isOpen=!1,this._remainingTime=.12,this._expressionManager.setValue("blink",1)}open(){this._isOpen=!0,this._remainingTime=5,this._expressionManager.setValue("blink",0)}constructor(e){this._expressionManager=e,this._remainingTime=0,this._isAutoBlink=!0,this._isOpen=!0}}class p{playEmotion(e){var t,n,r;if("neutral"!=this._currentEmotion&&(null==(n=this._expressionManager)||n.setValue(this._currentEmotion,0)),"neutral"==e){null==(r=this._autoBlink)||r.setEnable(!0),this._currentEmotion=e;return}let i=(null==(t=this._autoBlink)?void 0:t.setEnable(!1))||0;this._currentEmotion=e,setTimeout(()=>{var t;null==(t=this._expressionManager)||t.setValue(e,1)},1e3*i)}lipSync(e,t){if(this._currentLipSync){var n;null==(n=this._expressionManager)||n.setValue(this._currentLipSync.preset,0)}this._currentLipSync={preset:e,value:t}}update(e){if(this._autoBlink&&this._autoBlink.update(e),this._currentLipSync){var t;let e="neutral"===this._currentEmotion?.5*this._currentLipSync.value:.25*this._currentLipSync.value;null==(t=this._expressionManager)||t.setValue(this._currentLipSync.preset,e)}}constructor(e,t){this._autoLookAt=new c(e,t),this._currentEmotion="neutral",this._currentLipSync=null,e.expressionManager&&(this._expressionManager=e.expressionManager,this._autoBlink=new d(e.expressionManager))}}class h{playEmotion(e){this._expressionController.playEmotion(e)}lipSync(e,t){this._expressionController.lipSync(e,t)}update(e){this._expressionController.update(e)}constructor(e,t){this._expressionController=new p(e,t)}}class m{createAnimationClip(e){let t=[];if(t.push(...this.createHumanoidTracks(e)),null!=e.expressionManager&&t.push(...this.createExpressionTracks(e.expressionManager)),null!=e.lookAt){let e=this.createLookAtTrack("lookAtTargetParent.quaternion");null!=e&&t.push(e)}return new o.tz3("Clip",this.duration,t)}createHumanoidTracks(e){var t,n;let r=e.humanoid,i=e.meta.metaVersion,a=[];for(let[e,n]of this.humanoidTracks.rotation.entries()){let l=null==(t=r.getNormalizedBoneNode(e))?void 0:t.name;if(null!=l){let e=new o.MBL("".concat(l,".quaternion"),n.times,n.values.map((e,t)=>"0"===i&&t%2==0?-e:e));a.push(e)}}for(let[e,t]of this.humanoidTracks.translation.entries()){let o=null==(n=r.getNormalizedBoneNode(e))?void 0:n.name;if(null!=o){let e=this.restHipsPosition.y,n=r.getNormalizedAbsolutePose().hips.position[1]/e,l=t.clone();l.values=l.values.map((e,t)=>("0"===i&&t%3!=1?-e:e)*n),l.name="".concat(o,".position"),a.push(l)}}return a}createExpressionTracks(e){let t=[];for(let[n,r]of this.expressionTracks.entries()){let i=e.getExpressionTrackName(n);if(null!=i){let e=r.clone();e.name=i,t.push(e)}}return t}createLookAtTrack(e){if(null==this.lookAtTrack)return null;let t=this.lookAtTrack.clone();return t.name=e,t}constructor(){this.duration=0,this.restHipsPosition=new o.Pq0,this.humanoidTracks={translation:new Map,rotation:new Map},this.expressionTracks=new Map,this.lookAtTrack=null}}let f=new o.kn4,g=new o.PTz,w=new o.PTz,y=new o.PTz;class x{get name(){return"VRMC_vrm_animation"}async afterRoot(e){var t;let n=e.parser.json,r=n.extensionsUsed;if(null==r||-1==r.indexOf(this.name))return;let i=null==(t=n.extensions)?void 0:t[this.name];if(null==i)return;let a=this._createNodeMap(i),l=await this._createBoneWorldMatrixMap(e,i),s=i.humanoid.humanBones.hips.node,u=(await e.parser.getDependency("node",s)).getWorldPosition(new o.Pq0),c=e.animations.map((e,t)=>{let r=n.animations[t],i=this._parseAnimation(e,r,a,l);return i.restHipsPosition=u,i});e.userData.vrmAnimations=c}_createNodeMap(e){var t,n,r,i,o;let a=new Map,l=new Map,s=null!=(o=null==(t=e.lookAt)?void 0:t.node)?o:null,u=null==(n=e.humanoid)?void 0:n.humanBones;u&&Object.entries(u).forEach(e=>{let[t,n]=e,{node:r}=n;a.set(r,t)});let c=null==(r=e.expressions)?void 0:r.preset;c&&Object.entries(c).forEach(e=>{let[t,n]=e,{node:r}=n;l.set(r,t)});let d=null==(i=e.expressions)?void 0:i.custom;return d&&Object.entries(d).forEach(e=>{let[t,n]=e,{node:r}=n;l.set(r,t)}),{humanoidIndexToName:a,expressionsIndexToName:l,lookAtIndex:s}}async _createBoneWorldMatrixMap(e,t){e.scene.updateWorldMatrix(!1,!0);let n=await e.parser.getDependencies("node"),r=new Map;for(let[e,{node:a}]of Object.entries(t.humanoid.humanBones)){let t=n[a];if(r.set(e,t.matrixWorld),"hips"===e){var i,o;r.set("hipsParent",null!=(o=null==(i=t.parent)?void 0:i.matrixWorld)?o:f)}}return r}_parseAnimation(e,t,n,r){let i=e.tracks,a=t.channels,s=new m;return s.duration=e.duration,a.forEach((e,t)=>{let a=e.target.node,u=i[t];if(null==a)return;let c=n.humanoidIndexToName.get(a);if(null!=c){let e=l.ro[c];for(;null!=e&&null==r.get(e);)e=l.ro[e];null!=e||(e="hipsParent");let t=u.clone();t.name="".concat(c,".quaternion");let n=(function(e,t){let n=e.length,r=[],i=[],o=0;for(let t=0;t<n;t++){let n=e[t];o<=0&&(o=4,i=[],r.push(i)),i.push(n),o--}return r})(t.values,0).map((n,i)=>{let o=t.times[i],a=g.fromArray(n,0),l=r.get(c),s=r.get(e),u=y.setFromRotationMatrix(s).invert().multiply(w.setFromRotationMatrix(l).multiply(a)).normalize();return[o,u.x,u.y,u.z,u.w]});s.humanoidTracks.rotation.set(c,new o.MBL(t.name,n.flatMap(e=>e[0]),n.flatMap(e=>e.slice(1))))}let d=n.expressionsIndexToName.get(a);if(null!=d){let e=u.clone();e.name="expressions.".concat(d),s.expressionTracks.set(d,e)}if(a===n.lookAtIndex){let e=u.clone();e.name="lookAt.rotation",s.lookAtTrack=e}}),s}constructor(e){this.parser=e}}let M=new s.B;async function v(e){console.log("\uD83C\uDFAD Loading VRMAnimation from:",e);try{let t=await M.loadAsync(e);console.log("\uD83C\uDFAD GLTF loaded:",t),console.log("\uD83C\uDFAD GLTF userData:",t.userData);let n=t.userData.vrmAnimations;console.log("\uD83C\uDFAD VRM animations found:",(null==n?void 0:n.length)||0);let r=null==n?void 0:n[0];return console.log("\uD83C\uDFAD Selected VRM animation:",r),r&&(console.log("\uD83C\uDFAD Animation duration:",r.duration),console.log("\uD83C\uDFAD Animation humanoid tracks:",r.humanoidTracks)),null!=r?r:null}catch(e){return console.error("\uD83C\uDFAD Error loading VRM animation:",e),null}}M.register(e=>new x(e));class k{update(){this.analyser.getFloatTimeDomainData(this.timeDomainData);let e=0;for(let t=0;t<2048;t++)e=Math.max(e,Math.abs(this.timeDomainData[t]));return(e=1/(1+Math.exp(-45*e+5)))<.1&&(e=0),{volume:e}}async playFromArrayBuffer(e,t){let n=await this.audio.decodeAudioData(e),r=this.audio.createBufferSource();r.buffer=n,r.connect(this.analyser),r.start(),t&&r.addEventListener("ended",t)}async playFromURL(e,t){let n=await fetch(e),r=await n.arrayBuffer();this.playFromArrayBuffer(r,t)}constructor(e){this.audio=e,this.analyser=e.createAnalyser(),this.timeDomainData=new Float32Array(2048)}}function _(e){let{className:t}=e,n=(0,i.useRef)(null),[c,d]=(0,i.useState)(!1),[p,m]=(0,i.useState)(null),[f,g]=(0,i.useState)(""),w=(0,i.useRef)(null),y=(0,i.useRef)(null),x=(0,i.useRef)(null),M=(0,i.useRef)(null),_=(0,i.useRef)(null),A=(0,i.useRef)(null),T=(0,i.useRef)(null),b=(0,i.useRef)(null),N=(0,i.useRef)(null),R=(0,i.useRef)(null),B=(0,i.useRef)(null),L=(0,i.useCallback)(async e=>{try{if(console.log("\uD83C\uDFAD Loading idle animation..."),b.current&&e.humanoid){let t=e.humanoid.getNormalizedBoneNode("leftUpperArm"),n=e.humanoid.getNormalizedBoneNode("rightUpperArm"),r=[];if(t){let e=new o.MBL(t.name+".quaternion",[0],[0,0,-.6,.8]);r.push(e)}if(n){let e=new o.MBL(n.name+".quaternion",[0],[0,0,.6,.8]);r.push(e)}if(r.length>0){let e=new o.tz3("posefix",.1,r),t=b.current.clipAction(e);t.setLoop(o.G3T,1),t.clampWhenFinished=!0,t.play(),console.log("\uD83C\uDFAD T-pose fix applied")}}try{let t=await v("./idle_loop.vrma");if(t&&b.current){let n=t.createAnimationClip(e),r=b.current.clipAction(n);r.setLoop(o.aMy,1/0),r.weight=1,r.play(),console.log("\uD83C\uDFAD Idle animation loaded and playing")}}catch(t){if(console.log("\uD83C\uDFAD VRMAnimation failed, using simple body sway animation"),b.current&&e.humanoid){console.log("\uD83C\uDFAD Checking body bones:");let t=e.humanoid.getNormalizedBoneNode("spine"),n=e.humanoid.getNormalizedBoneNode("hips"),r=e.humanoid.getNormalizedBoneNode("chest"),i=e.humanoid.getNormalizedBoneNode("upperChest");console.log("  spine:",t?t.name:"NOT FOUND"),console.log("  hips:",n?n.name:"NOT FOUND"),console.log("  chest:",r?r.name:"NOT FOUND"),console.log("  upperChest:",i?i.name:"NOT FOUND");let a=[];if(t){let e=new o.MBL(t.name+".quaternion",[0,3,6,9],[0,0,0,1,0,.9,0,.9,0,-.9,0,.9,0,0,0,1]);a.push(e),console.log("  \uD83C\uDFAD Added spine rotation track")}if(n){let e=new o.MBL(n.name+".quaternion",[0,3,6,9],[0,0,0,1,0,.45,0,.893,0,-.45,0,.893,0,0,0,1]);a.push(e),console.log("  \uD83C\uDFAD Added hips rotation track")}if(r){let e=new o.MBL(r.name+".quaternion",[0,1.5,3],[0,0,0,1,0,0,.05,.999,0,0,0,1]);a.push(e),console.log("  \uD83C\uDFAD Added chest rotation track")}if(i){let e=new o.MBL(i.name+".quaternion",[0,2.5,5],[0,0,0,1,.05,0,0,.999,0,0,0,1]);a.push(e),console.log("  \uD83C\uDFAD Added upperChest rotation track")}if(a.length>0){let e=new o.tz3("bodysway",9,a),t=b.current.clipAction(e);t.setLoop(o.aMy,1/0),t.weight=1,t.play(),console.log("\uD83C\uDFAD Strong body sway animation applied")}}}}catch(e){console.error("\uD83C\uDFAD Failed to load idle animation:",e)}},[b]),E=(0,i.useCallback)(e=>{var t;(null==(t=e.humanoid)?void 0:t.getNormalizedBoneNode("head"))&&x.current&&B.current&&(x.current.position.set(.1,1.1,.8),B.current.target.set(0,1,0),B.current.update())},[x,B]),D=(0,i.useCallback)(async e=>{if(w.current){d(!0),m(null),g("");try{M.current&&(w.current.remove(M.current.scene),l.dG.deepDispose(M.current.scene));let t=new s.B;t.register(e=>new l.aQ(e));let n=(await t.parseAsync(await e.arrayBuffer())).userData.vrm;M.current=n,w.current.add(n.scene),l.dG.rotateVRM0(n),n.scene.traverse(e=>{e.frustumCulled=!1}),b.current=new o.Iw4(n.scene),x.current&&(console.log("Initializing EmoteController for loaded VRM..."),T.current=new h(n,x.current),console.log("EmoteController initialized for loaded VRM:",T.current)),await L(n),E(n),console.log("VRM loaded successfully:",n)}catch(e){console.error("VRM loading error:",e),m(e instanceof Error?e.message:"VRMの読み込みに失敗しました")}finally{d(!1)}}},[L,E,w,M,g,d,m]),V=(0,i.useCallback)(async()=>{try{d(!0),m(null),M.current&&w.current&&(w.current.remove(M.current.scene),l.dG.deepDispose(M.current.scene));let e=new s.B;e.register(e=>new l.aQ(e));let t=(await e.loadAsync("/kotone_claude1.vrm")).userData.vrm;if(!t)throw Error("VRMデータが見つかりません");l.dG.rotateVRM0(t),t.scene.scale.setScalar(.8),t.scene.position.set(.12,0,0),t.scene.rotation.y=-.2,w.current&&(w.current.add(t.scene),M.current=t,t.scene.traverse(e=>{e.frustumCulled=!1}),b.current=new o.Iw4(t.scene),L(t),x.current&&(console.log("Initializing EmoteController for default VRM..."),T.current=new h(t,x.current),console.log("EmoteController initialized for default VRM:",T.current)),requestAnimationFrame(()=>{E(t)}),g("")),console.log("Default VRM loaded successfully:",t)}catch(e){console.error("Default VRM loading error:",e),m("デフォルトVRMの読み込みに失敗しました")}finally{d(!1)}},[L,E,w,M,b,x,T,g,d,m]);return(0,i.useEffect)(()=>{if(!n.current)return;let e=new o.Z58;e.background=null,w.current=e;let t=window.innerWidth,r=window.innerHeight,i=new o.ubm(35,t/r,.1,20);i.position.set(.1,1.1,.8),x.current=i;let l=new a.JeP({canvas:n.current,antialias:!1,alpha:!0,powerPreference:"high-performance"});l.outputColorSpace=o.er$,l.shadowMap.enabled=!1,l.setPixelRatio(Math.min(window.devicePixelRatio,2)),l.setSize(t,r),y.current=l;let s=new u.N(i,l.domElement);s.screenSpacePanning=!0,s.target.set(0,1,0),s.update(),B.current=s;let c=new o.ZyN(0xffede2,.625*Math.PI);c.position.set(1,1,1).normalize(),e.add(c);let d=new o.$p8(0xfff5f0,.425*Math.PI);e.add(d);let p=new o.zD7;_.current=p;try{let e=new(window.AudioContext||window.webkitAudioContext);R.current=e,N.current=new k(e),console.log("LipSync initialized")}catch(e){console.error("Failed to initialize LipSync:",e)}let h=0,m=t=>{if(A.current=requestAnimationFrame(m),t-h<22.22222222222222)return;h=t;let n=p.getDelta();if(b.current&&b.current.update(n),M.current&&M.current.update(n),N.current&&T.current){let{volume:e}=N.current.update();T.current.lipSync("aa",e)}T.current&&T.current.update(n),l.render(e,i)};m(0);let f=()=>{if(!i||!l)return;let e=window.innerWidth,t=window.innerHeight;l.setPixelRatio(window.devicePixelRatio),l.setSize(e,t),i.aspect=e/t,i.updateProjectionMatrix()};setTimeout(()=>f(),100),setTimeout(()=>f(),500),setTimeout(()=>f(),1e3),window.addEventListener("resize",f);let g=e=>{D(e.detail)},v=()=>{V()};window.addEventListener("loadVRM",g),window.addEventListener("loadDefaultVRM",v),window.playAudioWithLipSync=async e=>{N.current&&(console.log("\uD83C\uDFAD LipSync再生開始, サイズ:",e.byteLength),await N.current.playFromArrayBuffer(e))};let L=e=>{if("file://"===e.origin&&"lipSync"===e.data.type&&e.data.audioData){console.log("\uD83C\uDFAD postMessageで音声データ受信, サイズ:",e.data.audioData.length);let t=new Uint8Array(e.data.audioData).buffer;N.current&&N.current.playFromArrayBuffer(t)}};return window.addEventListener("message",L),()=>{window.removeEventListener("resize",f),window.removeEventListener("loadVRM",g),window.removeEventListener("loadDefaultVRM",v),window.removeEventListener("message",L),A.current&&cancelAnimationFrame(A.current),y.current&&y.current.dispose()}},[x,B,T,N,b,y,w,M,D,V]),(0,r.jsxs)("div",{className:"relative ".concat(t),style:{width:"100vw",height:"100vh",position:"fixed",top:0,left:0,margin:0,padding:0,paddingBottom:0},children:[(0,r.jsx)("canvas",{ref:n,style:{width:"100vw",height:"100vh",display:"block",margin:0,padding:0}}),c&&(0,r.jsx)("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"bg-white p-4 rounded-lg",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:"VRMを読み込み中..."})]})}),p&&(0,r.jsx)("div",{className:"absolute top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:(0,r.jsxs)("p",{className:"text-sm",children:["❌ ",p]})}),f&&(0,r.jsx)("div",{className:"absolute top-4 left-4 bg-gray-800 text-gray-200 text-xs px-2 py-1 rounded opacity-75",children:(0,r.jsx)("pre",{children:f})})]})}}}]);