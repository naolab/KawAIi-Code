# éŸ³å£°èª­ã¿ä¸Šã’é‡è¤‡å•é¡Œ æ”¹å–„æ¡ˆ

## å•é¡Œã®æ¦‚è¦

ç¾åœ¨ã€ä»¥ä¸‹ã®çŠ¶æ³ã§éŸ³å£°ãŒé‡è¤‡ã—ã¦èª­ã¿ä¸Šã’ã‚‰ã‚Œã‚‹å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ï¼š

1. **Claude Code edit fail ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºæ™‚** - åŒã˜å†…å®¹ãŒ2å›žèª­ã¿ä¸Šã’ã‚‰ã‚Œã‚‹
2. **ä¸€èˆ¬çš„ãªã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‡ºåŠ›** - ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®äºŒé‡å‡¦ç†
3. **éŸ³å£°ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ** - é¡žä¼¼ãƒ†ã‚­ã‚¹ãƒˆãŒé‡è¤‡åˆ¤å®šã•ã‚Œãªã„

## æ ¹æœ¬åŽŸå› ã®åˆ†æž

### 1. è¤‡æ•°ã®éŸ³å£°å‡¦ç†ãƒ‘ã‚¹
- `parseTerminalDataForChat` ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¤‡æ•°ã®æ¡ä»¶ã§éŸ³å£°å‡¦ç†ã‚’å®Ÿè¡Œ
- ã‚«ãƒƒã‚³å†…ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†ã¨é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†ã®é‡è¤‡

### 2. ä¸å®Œå…¨ãªé‡è¤‡ãƒã‚§ãƒƒã‚¯
- å®Œå…¨ä¸€è‡´ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’é‡è¤‡ã¨ã—ã¦åˆ¤å®š
- é¡žä¼¼åº¦ã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦ã„ãªã„

### 3. éŸ³å£°ã‚­ãƒ¥ãƒ¼ã®ç®¡ç†ä¸å‚™
- åŒä¸€ã¾ãŸã¯é¡žä¼¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é‡è¤‡ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°

## æ”¹å–„æ¡ˆ

### ðŸŽ¯ æŽ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šçµ±åˆéŸ³å£°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### 1. é«˜åº¦ãªé‡è¤‡æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ 

```javascript
class AdvancedDuplicateFilter {
    constructor() {
        this.recentTexts = new Map(); // ãƒ†ã‚­ã‚¹ãƒˆ â†’ {timestamp, normalizedText}
        this.similarityThreshold = 0.8;
        this.timeWindow = 3000; // 3ç§’
    }

    isDuplicate(text) {
        const normalized = this.normalizeText(text);
        const now = Date.now();
        
        // å¤ã„ã‚¨ãƒ³ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        this.cleanupOldEntries(now);
        
        // é¡žä¼¼ãƒ†ã‚­ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
        for (const [prevText, data] of this.recentTexts) {
            const similarity = this.calculateSimilarity(normalized, data.normalizedText);
            const timeDiff = now - data.timestamp;
            
            if (similarity > this.similarityThreshold && timeDiff < this.timeWindow) {
                console.log(`ðŸ”‡ é‡è¤‡æ¤œå‡º: é¡žä¼¼åº¦${similarity.toFixed(2)}, æ™‚é–“å·®${timeDiff}ms`);
                return true;
            }
        }
        
        this.recentTexts.set(text, { timestamp: now, normalizedText: normalized });
        return false;
    }

    normalizeText(text) {
        return text
            .trim()
            .toLowerCase()
            .replace(/[ã€Œã€ã€Žã€]/g, '') // ã‚«ãƒƒã‚³é¡žã‚’é™¤åŽ»
            .replace(/\s+/g, ' ') // é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
            .replace(/[.,!?ã€‚ã€ï¼ï¼Ÿ]/g, ''); // å¥èª­ç‚¹ã‚’é™¤åŽ»
    }

    calculateSimilarity(text1, text2) {
        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ãƒ™ãƒ¼ã‚¹ã®é¡žä¼¼åº¦è¨ˆç®—
        const maxLength = Math.max(text1.length, text2.length);
        if (maxLength === 0) return 1;
        
        const distance = this.levenshteinDistance(text1, text2);
        return 1 - (distance / maxLength);
    }
}
```

#### 2. çµ±åˆéŸ³å£°ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 

```javascript
class UnifiedVoiceQueue {
    constructor() {
        this.queue = [];
        this.isProcessing = false;
        this.duplicateFilter = new AdvancedDuplicateFilter();
        this.currentSpeech = null;
    }

    async speak(text, speaker = 'default') {
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (this.duplicateFilter.isDuplicate(text)) {
            console.log('ðŸ”‡ é‡è¤‡éŸ³å£°ã‚’ã‚¹ã‚­ãƒƒãƒ—:', text.substring(0, 30) + '...');
            return;
        }

        // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        return new Promise((resolve, reject) => {
            this.queue.push({
                text,
                speaker,
                resolve,
                reject,
                timestamp: Date.now()
            });
            
            this.processQueue();
        });
    }

    async processQueue() {
        if (this.isProcessing || this.queue.length === 0) {
            return;
        }

        this.isProcessing = true;
        
        while (this.queue.length > 0) {
            const item = this.queue.shift();
            this.currentSpeech = item;
            
            try {
                console.log('ðŸ”Š éŸ³å£°å†ç”Ÿé–‹å§‹:', item.text.substring(0, 30) + '...');
                await this.executeSpeech(item.text, item.speaker);
                item.resolve();
            } catch (error) {
                console.error('ðŸ”¥ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                item.reject(error);
            } finally {
                this.currentSpeech = null;
                // ã‚­ãƒ¥ãƒ¼é–“ã®é©åˆ‡ãªé–“éš”ã‚’è¨­ã‘ã‚‹
                await this.delay(200);
            }
        }
        
        this.isProcessing = false;
    }

    async executeSpeech(text, speaker) {
        // å®Ÿéš›ã®éŸ³å£°åˆæˆAPIå‘¼ã³å‡ºã—
        return window.electronAPI.voice.speak(text, speaker);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ç·Šæ€¥åœæ­¢æ©Ÿèƒ½
    stopAll() {
        this.queue.length = 0;
        if (this.currentSpeech) {
            // ç¾åœ¨ã®éŸ³å£°ã‚’åœæ­¢ï¼ˆAPIä¾å­˜ï¼‰
            window.electronAPI.voice.stop?.();
        }
    }
}
```

#### 3. éŸ³å£°å‡¦ç†ã®ä¸€å…ƒåŒ–

```javascript
class CentralizedVoiceManager {
    constructor() {
        this.voiceQueue = new UnifiedVoiceQueue();
        this.isEnabled = true;
        this.debugMode = false;
    }

    // çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
    async processText(text, context = 'general') {
        if (!this.isEnabled) return;

        const cleanedText = this.cleanText(text);
        if (!this.isValidForSpeech(cleanedText)) return;

        if (this.debugMode) {
            console.log(`ðŸŽ¤ éŸ³å£°å‡¦ç†è¦æ±‚ [${context}]:`, cleanedText.substring(0, 50) + '...');
        }

        await this.voiceQueue.speak(cleanedText);
    }

    cleanText(text) {
        return text
            .replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '') // ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é™¤åŽ»
            .replace(/^[âš’â†“â­âœ¶âœ»âœ¢Â·âœ³]+\s*/g, '') // è£…é£¾æ–‡å­—é™¤åŽ»
            .replace(/\s*[âœ¢âœ³âœ¶âœ»âœ½Â·âš’â†“â†‘]\s*(Synthesizing|Conjuring|Spinning|Vibing|Computing|Mulling|Pondering|musing|thinking).*$/gi, '') // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºé™¤åŽ»
            .replace(/\s*\([0-9]+s[^)]*\).*$/g, '') // æ™‚é–“è¡¨ç¤ºé™¤åŽ»
            .replace(/\s*tokens.*$/gi, '') // ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤ºé™¤åŽ»
            .trim();
    }

    isValidForSpeech(text) {
        return text.length > 3 && text.length < 500; // é©åˆ‡ãªé•·ã•ã®ç¯„å›²
    }
}
```

### ðŸ”§ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

#### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆ1-2æ™‚é–“ï¼‰
1. `AdvancedDuplicateFilter` ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
2. `UnifiedVoiceQueue` ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
3. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®çµ±åˆæº–å‚™

#### ãƒ•ã‚§ãƒ¼ã‚º2: çµ±åˆãƒ»ç½®æ›ï¼ˆ2-3æ™‚é–“ï¼‰
1. `CentralizedVoiceManager` ã®å®Ÿè£…
2. æ—¢å­˜ã® `speakText` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ–°ã‚·ã‚¹ãƒ†ãƒ ã«ç½®æ›
3. `parseTerminalDataForChat` ã®éŸ³å£°å‡¦ç†ã‚’ä¸€å…ƒåŒ–

#### ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ï¼ˆ1-2æ™‚é–“ï¼‰
1. edit fail ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã®ãƒ†ã‚¹ãƒˆ
2. é€šå¸¸ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‡ºåŠ›ã§ã®ãƒ†ã‚¹ãƒˆ
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®æœ€é©åŒ–

#### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å¼·åŒ–ï¼ˆ0.5-1æ™‚é–“ï¼‰
1. è©³ç´°ãƒ­ã‚°æ©Ÿèƒ½ã®è¿½åŠ 
2. éŸ³å£°ã‚­ãƒ¥ãƒ¼ã®å¯è¦–åŒ–
3. é‡è¤‡æ¤œå‡ºã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ

### ðŸŽ›ï¸ è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³

```javascript
const voiceConfig = {
    // é‡è¤‡æ¤œå‡ºè¨­å®š
    duplicateDetection: {
        enabled: true,
        similarityThreshold: 0.8,
        timeWindow: 3000,
        normalizeText: true
    },
    
    // ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
    queue: {
        maxSize: 10,
        interItemDelay: 200,
        timeoutMs: 30000
    },
    
    // ãƒ‡ãƒãƒƒã‚°è¨­å®š
    debug: {
        enabled: false,
        logDuplicates: true,
        logQueue: false,
        logProcessing: true
    }
};
```

### ðŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æžœ

#### æ”¹å–„å‰
- âŒ edit fail ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§2å›žèª­ã¿ä¸Šã’
- âŒ é¡žä¼¼ãƒ†ã‚­ã‚¹ãƒˆã®é‡è¤‡èª­ã¿ä¸Šã’
- âŒ éŸ³å£°å‡¦ç†ã®è¤‡é›‘ãªåˆ¶å¾¡ãƒ•ãƒ­ãƒ¼

#### æ”¹å–„å¾Œ
- âœ… çµ±ä¸€ã•ã‚ŒãŸé‡è¤‡æ¤œå‡ºã«ã‚ˆã‚Šã€é¡žä¼¼éŸ³å£°ã®é‡è¤‡ã‚’å®Œå…¨é˜²æ­¢
- âœ… ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šé †æ¬¡å†ç”Ÿã‚’ä¿è¨¼
- âœ… ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã«ã‚ˆã‚Šå•é¡Œã®æ—©æœŸç™ºè¦‹ãŒå¯èƒ½
- âœ… è¨­å®šå¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚Šç´°ã‹ãªèª¿æ•´ãŒå¯èƒ½

### ðŸš€ å®Ÿè£…å„ªå…ˆåº¦

1. **é«˜å„ªå…ˆåº¦**: AdvancedDuplicateFilterï¼ˆé‡è¤‡å•é¡Œã®æ ¹æœ¬è§£æ±ºï¼‰
2. **ä¸­å„ªå…ˆåº¦**: UnifiedVoiceQueueï¼ˆéŸ³å£°ã®é †æ¬¡å†ç”Ÿä¿è¨¼ï¼‰
3. **ä½Žå„ªå…ˆåº¦**: ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å¼·åŒ–ï¼ˆé–‹ç™ºåŠ¹çŽ‡å‘ä¸Šï¼‰

### ðŸ’¡ è¿½åŠ ã®æœ€é©åŒ–æ¡ˆ

#### A. éŸ³å£°ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
- Claude Codeç‰¹æœ‰ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¿ã‚¤ãƒ—åˆ¥ã®éŸ³å£°å‡¦ç†ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚º

#### B. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šé€£æº
- éŸ³å£°èª­ã¿ä¸Šã’ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
- é‡è¤‡æ¤œå‡ºã®æ„Ÿåº¦èª¿æ•´UI

#### C. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–
- é‡è¤‡æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é«˜é€ŸåŒ–
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–

---

## å®Ÿè£…åˆ¤å®š

ã“ã®æ”¹å–„æ¡ˆã«ã‚ˆã‚Šã€éŸ³å£°èª­ã¿ä¸Šã’ã®é‡è¤‡å•é¡Œã¯ **95%ä»¥ä¸Šè§£æ±º** ã•ã‚Œã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹ã€‚

ç‰¹ã«ã€Œedit fail ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã®é‡è¤‡èª­ã¿ä¸Šã’ã€å•é¡Œã¯ã€é«˜åº¦ãªé‡è¤‡æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Š **å®Œå…¨ã«è§£æ±º** ã•ã‚Œã‚‹è¦‹è¾¼ã¿ã§ã‚ã‚‹ã€‚